<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B·∫£ng gi√°m s√°t ERA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 8px;
      display: flex;
      justify-content: center;
    }

    .monitor-box {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      padding: 10px 14px;
      width: 600px;
    }

    .monitor-box h2 {
      text-align: center;
      margin: 4px 0 8px 0;
      font-size: 17px;
      color: #333;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px 16px;
    }

    .item {
      display: flex;
      flex-direction: column;
      font-size: 14px;
      padding: 6px 8px;
    }

    .item .main {
      display: flex;
      align-items: center;
    }

    .item .main span {
      margin-left: 6px;
      flex: 1;
    }

    .raw {
      font-size: 12px;
      color: #666;
      margin-left: 26px; /* indent small */
    }

    .warning {
      font-weight: bold;
    }

    .safe { color: green; }
    .fire { color: red; }
    .intruder { color: orange; }
  </style>
</head>
<body>
  <div class="monitor-box">
    <h2>üìä B·∫£ng gi√°m s√°t</h2>

    <div class="grid">
      <div class="item">
        <div class="main">üå°Ô∏è <span>Nhi·ªát ƒë·ªô: <b id="temperature">--</b> ¬∞C</span></div>
      </div>

      <div class="item">
        <div class="main">üíß <span>ƒê·ªô ·∫©m: <b id="humidity">--</b> %</span></div>
      </div>

      <div class="item">
        <div class="main">‚è±Ô∏è <span>√Åp su·∫•t: <b id="pressure">--</b> kPa</span></div>
      </div>

      <div class="item">
        <div class="main">üå± <span>ƒê·ªô ·∫©m ƒë·∫•t: <b id="soil">--</b> %</span></div>
      </div>

      <div class="item">
        <div class="main">üåÄ <span>Ozone: <b id="ozone">--</b> ppm</span></div>
        <div id="ozoneRaw" class="raw">raw: --</div>
      </div>

      <div class="item">
        <div class="main">üî• <span>Kh√≠ gas: <b id="gas" class="warning safe">An to√†n</b></span></div>
        <div id="gasRaw" class="raw">raw: --</div>
      </div>

      <div class="item">
        <div class="main">üö∂ <span>Chuy·ªÉn ƒë·ªông: <b id="motion" class="warning safe">Kh√¥ng ph√°t hi·ªán</b></span></div>
        <div id="motionRaw" class="raw">raw: --</div>
      </div>
    </div>
  </div>

  <!-- ERA Widget -->
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <script>
    // Helper: ki·ªÉm tra gi√° tr·ªã "ON"
    function isOnValue(val) {
      if (val === undefined || val === null) return false;
      // chuy·ªÉn v·ªÅ chu·ªói vi·∫øt th∆∞·ªùng ƒë·ªÉ so s√°nh d·ªÖ
      const s = String(val).trim().toLowerCase();
      return s === "1" || s === "true" || s === "on" || s === "alert" || s === "detected";
    }

    const eraWidget = new EraWidget();

    const tempEl = document.getElementById("temperature");
    const humiEl = document.getElementById("humidity");
    const pressEl = document.getElementById("pressure");
    const soilEl = document.getElementById("soil");
    const ozoneEl = document.getElementById("ozone");
    const ozoneRawEl = document.getElementById("ozoneRaw");
    const gasEl = document.getElementById("gas");
    const gasRawEl = document.getElementById("gasRaw");
    const motionEl = document.getElementById("motion");
    const motionRawEl = document.getElementById("motionRaw");

    let configTemp, configHumi, configPress, configSoil, configOzone, configGas, configMotion;

    eraWidget.init({
      onConfiguration: (configuration) => {
        console.log("ERA configuration:", configuration);
        // G√°n m·∫∑c ƒë·ªãnh theo index (gi·ªØ t∆∞∆°ng th√≠ch v·ªõi code c≈©).
        configTemp   = configuration.realtime_configs[0];
        configHumi   = configuration.realtime_configs[1];
        configPress  = configuration.realtime_configs[2];
        configSoil   = configuration.realtime_configs[3];
        configOzone  = configuration.realtime_configs[4];
        configGas    = configuration.realtime_configs[5];
        configMotion = configuration.realtime_configs[6];

        // N·∫øu b·∫°n mu·ªën an to√†n h∆°n, c√≥ th·ªÉ t√¨m theo t√™n nh∆∞:
        // configMotion = configuration.realtime_configs.find(c => c.name && c.name.toLowerCase().includes('motion')) || configMotion;

        console.log("Mapped configs:", {
          temp: configTemp && configTemp.id,
          humi: configHumi && configHumi.id,
          press: configPress && configPress.id,
          soil: configSoil && configSoil.id,
          ozone: configOzone && configOzone.id,
          gas: configGas && configGas.id,
          motion: configMotion && configMotion.id
        });
      },

      onValues: (values) => {
        // Debug to√†n b·ªô values ƒë·ªÉ bi·∫øt server tr·∫£ g√¨
        console.log("onValues payload:", values);

        if (configTemp && values[configTemp.id]) {
          tempEl.textContent = values[configTemp.id].value;
        }
        if (configHumi && values[configHumi.id]) {
          humiEl.textContent = values[configHumi.id].value;
        }
        if (configPress && values[configPress.id]) {
          pressEl.textContent = values[configPress.id].value;
        }
        if (configSoil && values[configSoil.id]) {
          soilEl.textContent = values[configSoil.id].value;
        }

        // Ozone: c·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã v√† raw
        if (configOzone) {
          const ozoneVal = values[configOzone.id] ? values[configOzone.id].value : undefined;
          if (ozoneVal !== undefined) {
            ozoneEl.textContent = ozoneVal;
            ozoneRawEl.textContent = "raw: " + ozoneVal;
          } else {
            ozoneRawEl.textContent = "raw: --";
          }
        }

        // Gas: c·∫£nh b√°o + raw (m·ªü r·ªông ƒëi·ªÅu ki·ªán nh·∫≠n d·∫°ng)
        if (configGas) {
          const gasVal = values[configGas.id] ? values[configGas.id].value : undefined;
          console.log("Gas value raw:", gasVal);
          gasRawEl.textContent = gasVal === undefined ? "raw: --" : ("raw: " + gasVal);

          // d√πng h√†m isOnValue ƒë·ªÉ nh·∫≠n nhi·ªÅu d·∫°ng gi√° tr·ªã
          if (isOnValue(gasVal)) {
            gasEl.textContent = "Ph√°t hi·ªán kh√≠ gas!";
            gasEl.classList.remove("safe");
            gasEl.classList.add("fire");
          } else {
            gasEl.textContent = "An to√†n";
            gasEl.classList.remove("fire");
            gasEl.classList.add("safe");
          }
        }

        // Motion: c·∫£nh b√°o + raw
        if (configMotion) {
          const motionVal = values[configMotion.id] ? values[configMotion.id].value : undefined;
          console.log("Motion value raw:", motionVal);
          motionRawEl.textContent = motionVal === undefined ? "raw: --" : ("raw: " + motionVal);

          if (isOnValue(motionVal)) {
            motionEl.textContent = "C√≥ ng∆∞∆°ÃÄi!";
            motionEl.classList.remove("safe");
            motionEl.classList.add("intruder");
          } else {
            motionEl.textContent = "Kh√¥ng ph√°t hi·ªán";
            motionEl.classList.remove("intruder");
            motionEl.classList.add("safe");
          }
        }
      }
    });
  </script>
</body>
</html>
